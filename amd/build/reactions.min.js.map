{"version":3,"file":"reactions.min.js","sources":["../src/reactions.js"],"sourcesContent":["import $ from 'jquery';\n\nexport const init = (discussionid) => {\n    const getreactionsdata = () => new Promise((resolve, reject) => {\n        try {\n            $.get(`${M.cfg.wwwroot}/local/reactforum/reactionsdata.php?id=${discussionid}`, response => {\n                if (response && response.metadata) {\n                    return resolve(response);\n                }\n                return resolve(null);\n            });\n        } catch (ex) {\n            reject(ex);\n        }\n    });\n\n    const reacted = (metadata, $button, $reactionsarea, postreactions) => {\n        const $reactbuttons = $reactionsarea.find('.react-btn');\n        for (const reactbutton of $reactbuttons) {\n            const $reactbutton = $(reactbutton);\n            const reactionid = $reactbutton.attr('data-reaction-id');\n            if (!postreactions[reactionid]) {\n                $reactbutton.prop('disabled', true);\n            }\n            applybutton(metadata, $reactbutton, postreactions[reactionid]);\n        }\n        $button.prop('disabled', false);\n    };\n\n    const react = (metadata, $button, $reactionsarea) => {\n        const reactable = parseInt($button.attr('data-reactable'));\n        if (!reactable) {\n            return false;\n        }\n        const postid = $button.attr('data-post-id');\n        const reactionid = $button.attr('data-reaction-id');\n        $button.prop('disabled', true);\n        try {\n            $.post(`${M.cfg.wwwroot}/local/reactforum/react.php`, {\n                post: postid,\n                reaction: reactionid\n            }, response => {\n                $button.prop('disabled', false);\n                if (response.error) {\n                    throw response;\n                }\n                reacted(metadata, $button, $reactionsarea, response);\n            });\n        } catch (ex) {\n            $button.prop('disabled', false);\n            throw ex;\n        }\n    };\n\n    const getcountertext = (reactiontype, count) => reactiontype === 'text' ? `- ${count}` : count;\n\n    const applybutton = (metadata, $button, postreactiondata) => {\n        $button.removeClass('btn-primary btn-outline-primary');\n        $button.addClass(postreactiondata.reacted ? 'btn-primary' : 'btn-outline-primary');\n        const $counter = $button.find('.reaction-counter');\n        $counter.html(postreactiondata.count !== null ?\n            getcountertext(metadata.reactiontype, postreactiondata.count.toString())\n            : '');\n        if (!parseInt(metadata.delayedcounter) || postreactiondata.count !== null) {\n            $counter.show();\n        } else {\n            $counter.hide();\n        }\n        $button.attr('data-reactable', postreactiondata.enabled ? 1 : 0);\n        $button.css('cursor', postreactiondata.enabled ? 'pointer' : 'default');\n    };\n\n    const addreactionbuttons = ($forumpost, reactionsdata) => {\n        const postid = $forumpost.attr('data-post-id');\n        const $appendedelement = $($forumpost.find('.post-content-container')[0]);\n        const $reactionsarea = $('<div>');\n        $reactionsarea.addClass('reactions-area');\n        const postdata = reactionsdata.posts[postid];\n        if (!postdata) {\n            return;\n        }\n        for (const reaction of reactionsdata.reactions) {\n            if (!postdata[reaction.id]) {\n                continue;\n            }\n            const postreactiondata = postdata[reaction.id];\n            const $button = $('<button>');\n            $button.addClass('btn react-btn mx-1');\n            $button.attr('data-post-id', postid)\n                .attr('data-reaction-id', reaction.id);\n            if (reactionsdata.metadata.reactiontype === 'text') {\n                $button.html(reaction.reaction);\n            } else if (reactionsdata.metadata.reactiontype === 'image') {\n                $button.html($('<img>')\n                    .addClass('reaction-img')\n                    .attr('src', `${M.cfg.wwwroot}/local/reactforum/image.php?id=${reaction.id}`))\n                    .attr('alt', reaction.reaction)\n                    .attr('title', reaction.reaction);\n            } else {\n                continue;\n            }\n            const $counter = $('<span>');\n            $counter.addClass('reaction-counter ml-1');\n            $button.append($counter);\n            $button.on('click', function() {\n                react(reactionsdata.metadata, $(this), $reactionsarea);\n            });\n            applybutton(reactionsdata.metadata, $button, postreactiondata);\n            $reactionsarea.append($button);\n        }\n        $appendedelement.append($reactionsarea);\n    };\n\n    const addmanagebutton = () => {\n        const $firstpost = $('.firstpost[data-content=\"forum-post\"]');\n        if (!$firstpost.length) {\n            return;\n        }\n        const $postactions = $firstpost.find('.post-actions');\n        if (!$postactions.length) {\n            return;\n        }\n        $postactions.append(\n            $('<a>').attr('data-region', 'post-action')\n                .attr('href', `${M.cfg.wwwroot}/local/reactforum/managereactions.php?d=${discussionid}`)\n                .attr('role', 'menuitem')\n                .addClass('btn btn-link')\n                .html(M.str.local_reactforum.reactions)\n        );\n    };\n\n    $(() => {\n        const initialise = async() => {\n            const reactionsdata = await getreactionsdata();\n            if (!reactionsdata) {\n                return;\n            }\n            if (reactionsdata.canmanage) {\n                addmanagebutton();\n            }\n            const $forumposts = $('.forumpost');\n            for (const forumpost of $forumposts) {\n                addreactionbuttons($(forumpost), reactionsdata);\n            }\n        };\n\n        initialise();\n    });\n};\n"],"names":["obj","_jquery","__esModule","default","_exports","init","discussionid","react","metadata","$button","$reactionsarea","parseInt","attr","postid","reactionid","prop","$","post","concat","M","cfg","wwwroot","reaction","response","error","reacted","postreactions","$reactbuttons","find","reactbutton","$reactbutton","applybutton","ex","postreactiondata","removeClass","addClass","$counter","getcountertext","reactiontype","count","html","toString","delayedcounter","hide","show","enabled","css","addreactionbuttons","$forumpost","reactionsdata","$appendedelement","postdata","posts","reactions","id","append","on","this","async","Promise","resolve","reject","get","canmanage","addmanagebutton","$firstpost","length","$postactions","str","local_reactforum","$forumposts","forumpost","initialise"],"mappings":"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"}